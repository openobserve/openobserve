name: Bug Checker Agent

# Checks open bugs to verify if fixes exist in codebase
# TODO: Remove push trigger after testing
on:
  push:
    branches: [feature/bug-checker-agent]
    paths: ['.github/workflows/bug-checker.yml']
  schedule:
    - cron: "0 9 * * 1" # Every Monday at 9 AM UTC
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run mode (only report, don't comment)"
        required: false
        default: false
        type: boolean
      days_threshold:
        description: "Only check issues older than N days"
        required: false
        default: "30"
        type: string
      max_bugs_to_check:
        description: "Max bugs to check per run"
        required: false
        default: "35"
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: read

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # Job 1: Find bugs with linked PRs
  find-bugs:
    runs-on: ubuntu-latest
    outputs:
      bugs_to_verify: ${{ steps.collect.outputs.bugs_to_verify }}
      has_bugs: ${{ steps.collect.outputs.has_bugs }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find bugs with linked PRs
        id: collect
        run: |
          set -e

          DAYS_THRESHOLD="${{ inputs.days_threshold || '30' }}"
          MAX_BUGS="${{ inputs.max_bugs_to_check || '35' }}"

          echo "Configuration: days_threshold=$DAYS_THRESHOLD, max_bugs=$MAX_BUGS"

          # Get cutoff date
          CUTOFF_DATE=$(date -d "-${DAYS_THRESHOLD} days" +%Y-%m-%d)
          echo "Checking bugs created before: $CUTOFF_DATE"

          # Get open bugs
          echo ""
          echo "=== Fetching open bugs with '☢️ Bug' label ==="

          BUGS=$(gh issue list \
            --label "☢️ Bug" \
            --state open \
            --json number,title,body,createdAt \
            --limit 100)

          TOTAL_BUGS=$(echo "$BUGS" | jq length)
          echo "Found $TOTAL_BUGS open bugs"

          # Collect bugs to verify
          BUGS_TO_VERIFY="[]"
          BUGS_CHECKED=0

          echo ""
          echo "=== Checking for linked PRs ==="

          for row in $(echo "$BUGS" | jq -r '.[] | @base64'); do
            if [[ "$BUGS_CHECKED" -ge "$MAX_BUGS" ]]; then
              echo "Reached limit of $MAX_BUGS bugs."
              break
            fi

            _jq() {
              echo "$row" | base64 --decode | jq -r "$1"
            }

            NUMBER=$(_jq '.number')
            TITLE=$(_jq '.title')
            BODY=$(_jq '.body')
            CREATED=$(_jq '.createdAt')

            # Skip recent bugs
            if [[ "$CREATED" > "$CUTOFF_DATE" ]]; then
              echo "Skipping #$NUMBER - too recent"
              continue
            fi

            BUGS_CHECKED=$((BUGS_CHECKED + 1))
            echo "[$BUGS_CHECKED] Checking #$NUMBER: $TITLE"

            # Check if already processed
            EXISTING=$(gh issue view "$NUMBER" --json comments \
              --jq '.comments[] | select(.body | contains("Bug Checker Agent")) | .id' \
              | head -1 || true)

            if [[ -n "$EXISTING" ]]; then
              echo "  Already processed, skipping"
              continue
            fi

            # Search for merged PRs
            LINKED_PRS=$(gh pr list \
              --state merged \
              --search "#$NUMBER in:body,title" \
              --json number,title \
              --limit 5 2>/dev/null || echo "[]")

            PR_COUNT=$(echo "$LINKED_PRS" | jq length)

            if [[ "$PR_COUNT" -gt 0 ]]; then
              echo "  ✓ Found $PR_COUNT linked PR(s)"

              # Add to verification list
              PR_NUMBERS=$(echo "$LINKED_PRS" | jq -r '.[].number' | tr '\n' ',' | sed 's/,$//')

              # Escape body for JSON (truncate to 500 chars)
              BODY_ESCAPED=$(echo "$BODY" | head -c 500 | jq -Rs '.')

              BUGS_TO_VERIFY=$(echo "$BUGS_TO_VERIFY" | jq \
                --argjson num "$NUMBER" \
                --arg title "$TITLE" \
                --argjson body "$BODY_ESCAPED" \
                --arg prs "$PR_NUMBERS" \
                '. += [{"number": $num, "title": $title, "body": $body, "linked_prs": $prs}]')
            else
              echo "  ✗ No linked PRs"
            fi

            sleep 1
          done

          BUG_COUNT=$(echo "$BUGS_TO_VERIFY" | jq length)
          echo ""
          echo "=== Found $BUG_COUNT bugs to verify with Claude ==="

          # Output for next job
          echo "bugs_to_verify=$(echo "$BUGS_TO_VERIFY" | jq -c '.')" >> $GITHUB_OUTPUT

          if [[ "$BUG_COUNT" -gt 0 ]]; then
            echo "has_bugs=true" >> $GITHUB_OUTPUT
          else
            echo "has_bugs=false" >> $GITHUB_OUTPUT
          fi

  # Job 2: Use Claude to verify each bug
  verify-bugs:
    needs: find-bugs
    if: needs.find-bugs.outputs.has_bugs == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Verify bugs with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: |
            You are a Bug Verification Agent. Analyze each bug below and check if the fix exists in the codebase.

            ## Bugs to Verify
            ${{ needs.find-bugs.outputs.bugs_to_verify }}

            ## Instructions
            For EACH bug in the list above:
            1. Read the bug description to understand what the issue is
            2. Search the codebase to find relevant code
            3. Check if the linked PR's fix is actually present in the code
            4. Determine if the bug appears to be fixed

            ## Output Format
            For each bug, output a JSON object with your analysis:
            ```json
            {
              "bug_number": <number>,
              "title": "<title>",
              "status": "FIXED" | "NOT_FIXED" | "NEEDS_REVIEW",
              "evidence": "<brief explanation of what you found>",
              "files_checked": ["<list of files you examined>"]
            }
            ```

            After analyzing all bugs, create a summary comment on each bug that is FIXED:
            - Use `gh issue comment <number>` to post a verification comment
            - Only comment on bugs with status "FIXED"
            - Include the evidence in your comment

            DRY_RUN: ${{ inputs.dry_run || 'false' }}
            If DRY_RUN is true, just output the analysis but don't post comments.

          allowed_tools: "Read,Glob,Grep,Bash"
          timeout_minutes: 30
