name: Bug Checker Agent

# Checks open bugs to find those potentially fixed by merged PRs
# TODO: Remove push trigger after testing
on:
  push:
    branches: [feature/bug-checker-agent]
    paths: ['.github/workflows/bug-checker.yml']
  schedule:
    - cron: "0 9 * * 1" # Every Monday at 9 AM UTC
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run mode (only report, don't comment)"
        required: false
        default: false
        type: boolean
      days_threshold:
        description: "Only check issues older than N days"
        required: false
        default: "30"
        type: string
      max_bugs_to_analyze:
        description: "Max bugs to analyze with Claude"
        required: false
        default: "5"
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: read

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  check-fixed-bugs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find bugs and check for fixes
        id: analyze
        run: |
          set -e

          DRY_RUN="${{ inputs.dry_run }}"
          DAYS_THRESHOLD="${{ inputs.days_threshold || '30' }}"
          MAX_BUGS="${{ inputs.max_bugs_to_analyze || '5' }}"

          echo "Configuration: dry_run=$DRY_RUN, days_threshold=$DAYS_THRESHOLD, max_bugs=$MAX_BUGS"

          # Get cutoff date
          if [[ "$OSTYPE" == "darwin"* ]]; then
            CUTOFF_DATE=$(date -v-${DAYS_THRESHOLD}d +%Y-%m-%d)
          else
            CUTOFF_DATE=$(date -d "-${DAYS_THRESHOLD} days" +%Y-%m-%d)
          fi
          echo "Checking bugs created before: $CUTOFF_DATE"

          # Get open bugs older than threshold
          echo ""
          echo "=== Fetching open bugs with 'â˜¢ï¸ Bug' label ==="

          BUGS=$(gh issue list \
            --label "â˜¢ï¸ Bug" \
            --state open \
            --json number,title,body,createdAt,url \
            --limit 100)

          TOTAL_BUGS=$(echo "$BUGS" | jq length)
          echo "Found $TOTAL_BUGS open bugs"

          # Arrays for results
          BUGS_WITH_PRS=""
          BUGS_WITHOUT_PRS=""
          ANALYZED_COUNT=0

          # Process each bug
          echo ""
          echo "=== Checking for linked PRs ==="

          for row in $(echo "$BUGS" | jq -r '.[] | @base64'); do
            _jq() {
              echo "$row" | base64 --decode | jq -r "$1"
            }

            NUMBER=$(_jq '.number')
            TITLE=$(_jq '.title')
            CREATED=$(_jq '.createdAt')

            # Skip recent bugs
            if [[ "$CREATED" > "$CUTOFF_DATE" ]]; then
              echo "Skipping #$NUMBER - too recent"
              continue
            fi

            echo ""
            echo "Checking #$NUMBER: $TITLE"

            # Search for merged PRs referencing this issue
            # Using gh search with exact issue reference
            LINKED_PRS=$(gh pr list \
              --state merged \
              --search "#$NUMBER in:body,title" \
              --json number,title,url \
              --limit 10 2>/dev/null || echo "[]")

            PR_COUNT=$(echo "$LINKED_PRS" | jq length)

            if [[ "$PR_COUNT" -gt 0 ]]; then
              echo "  âœ“ Found $PR_COUNT linked PR(s)"

              # Build PR list for comment
              PR_LIST=$(echo "$LINKED_PRS" | jq -r '.[] | "- #\(.number): \(.title)"')

              # Store bug info
              BUGS_WITH_PRS="$BUGS_WITH_PRS
              $NUMBER|$TITLE|$PR_LIST"
            else
              echo "  âœ— No linked PRs"
              BUGS_WITHOUT_PRS="$BUGS_WITHOUT_PRS
              $NUMBER|$TITLE"

              ((ANALYZED_COUNT++))
            fi

            # Rate limit protection
            sleep 1
          done

          echo ""
          echo "=== Results ==="
          echo "Bugs with linked PRs: $(echo "$BUGS_WITH_PRS" | grep -c '|' || echo 0)"
          echo "Bugs without linked PRs: $(echo "$BUGS_WITHOUT_PRS" | grep -c '|' || echo 0)"

          # Comment on bugs with linked PRs
          echo ""
          echo "=== Processing bugs with linked PRs ==="

          echo "$BUGS_WITH_PRS" | while IFS='|' read -r NUMBER TITLE PR_LIST; do
            [[ -z "$NUMBER" ]] && continue
            NUMBER=$(echo "$NUMBER" | xargs)  # trim whitespace

            echo ""
            echo "Processing #$NUMBER"

            # Check if already commented
            EXISTING=$(gh issue view "$NUMBER" --json comments \
              --jq '.comments[] | select(.body | contains("Bug Checker Agent")) | .id' \
              | head -1)

            if [[ -n "$EXISTING" ]]; then
              echo "  Already commented, skipping"
              continue
            fi

            COMMENT_BODY="## ðŸ” Bug Checker Agent Report

          **Status:** Potentially fixed via linked PR(s)

          This issue appears to have been addressed by the following merged PR(s):

          $PR_LIST

          **Action requested:** Please verify if this bug has been fixed and close this issue if appropriate.

          ---
          _Automated message from Bug Checker Agent_"

            if [[ "$DRY_RUN" == "true" ]]; then
              echo "  [DRY RUN] Would comment on #$NUMBER"
            else
              gh issue comment "$NUMBER" --body "$COMMENT_BODY"
              echo "  âœ“ Commented on #$NUMBER"

              # Add label
              gh issue edit "$NUMBER" --add-label "Needs-Testing" 2>/dev/null || true
            fi
          done

          # Generate summary
          echo ""
          echo "=== Summary ==="

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ” Bug Checker Agent Summary

          | Metric | Count |
          |--------|-------|
          | Total bugs checked | $TOTAL_BUGS |
          | Bugs with linked PRs | $(echo "$BUGS_WITH_PRS" | grep -c '|' || echo 0) |
          | Bugs without linked PRs | $(echo "$BUGS_WITHOUT_PRS" | grep -c '|' || echo 0) |
          | Mode | $([[ "$DRY_RUN" == "true" ]] && echo "ðŸ§ª Dry Run" || echo "ðŸš€ Live") |

          ### Bugs Without Linked PRs (Need Manual Review)
          These bugs have no linked PRs and may need investigation:

          EOF

          echo "$BUGS_WITHOUT_PRS" | head -20 | while IFS='|' read -r NUMBER TITLE; do
            [[ -z "$NUMBER" ]] && continue
            NUMBER=$(echo "$NUMBER" | xargs)
            echo "- #$NUMBER: $TITLE" >> $GITHUB_STEP_SUMMARY
          done
