name: Claude PR Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

env:
  REVIEW_MARKER: "<!-- claude-pr-review -->"

jobs:
  review-with-tracking:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Full history needed to check what changed

      - name: PR Review with Progress Tracking
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true

          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            REVIEW_MARKER: <!-- claude-pr-review -->

            ## Your Task: Incremental PR Review

            You maintain a SINGLE review comment that you UPDATE on each run.
            This prevents comment spam when PRs have many commits.

            ### Step 1: Find Your Existing Review Comment

            Run: `gh pr view ${{ github.event.pull_request.number }} --json comments --jq '.comments[] | select(.body | contains("<!-- claude-pr-review -->")) | {id: .id, body: .body}'`

            ### Step 2: Get Current PR State

            Run: `gh pr diff ${{ github.event.pull_request.number }}` to see all changes.

            ### Step 3: Review the Code

            Focus areas:
            1. Code Quality - clean code, error handling, readability
            2. Security - vulnerabilities, input validation, auth
            3. Performance - bottlenecks, N+1 queries, memory issues
            4. Testing - coverage and edge cases
            5. Documentation - when critical

            ### Step 4: Update or Create Your Review Comment

            **If you found an existing review comment:**
            - Re-validate each issue against the CURRENT code
            - Remove issues that were FIXED
            - Keep issues that are STILL present
            - Add any NEW issues found
            - Update the comment using: `gh pr comment ${{ github.event.pull_request.number }} --edit-last --body "..."`

            **If no existing comment:**
            - Create one with your findings

            ### Comment Format

            Your comment MUST start with the marker and follow this format:

            ```
            <!-- claude-pr-review -->
            ## Claude Code Review

            **Last updated:** [commit SHA] | **Status:** [X issues / LGTM]

            ### Open Issues

            | # | File | Issue | Severity |
            |---|------|-------|----------|
            | 1 | `path/file.ts:42` | [Bug] Description. Fix: suggestion | High |

            ### Resolved ✅
            - ~~Issue that was fixed~~

            ---
            *Auto-updated on each push. Only open issues need attention.*
            ```

            ### Rules

            - **Be concise**: 1-2 sentences per issue
            - **No duplicates**: If issue exists, don't add it again
            - **Track resolution**: Move fixed issues to "Resolved" section
            - **If no issues**: Just show "Status: LGTM ✅" with empty table
            - **Max 10 open issues**: Prioritize by severity if more

          claude_args: |
            --allowedTools "Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh api:*),Read,Grep,Glob"