name: Notify Slack on stale PRs
permissions:
  contents: read
on:
  schedule:
    - cron: "20 17 * * *" # everyday at 4PM
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      - name: Get stale PRs
        uses: actions/github-script@v6
        id: stale-prs
        with:
          script: |
            const resp = await github.rest.search.issuesAndPullRequests({
              q: `repo:${{ github.repository }} is:pr is:open label:stale`
            });

            const prs = resp.data.items.map(pr => ({
              number: pr.number,
              title: pr.title,
              user: pr.user.login
            }));

            core.setOutput("prs", JSON.stringify(prs));

      - name: Build Slack message
        id: slack-msg
        run: |
          PRS=$(echo '${{ steps.stale-prs.outputs.prs }}' | jq -r '.[] | "- <https://github.com/${{ github.repository }}/pull/\(.number)|#\(.number) \(.title)> â€” @\(.user)"')
          MESSAGE="ðŸ”” *Stale Pull Requests in ${{ github.repository }}*\n\n$PRS"
          # Escape for JSON and create the payload
          PAYLOAD=$(jq -n --arg msg "$MESSAGE" '{text: $msg}')
          echo "payload<<EOF" >> $GITHUB_OUTPUT
          echo "$PAYLOAD" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        if: ${{ steps.stale-prs.outputs.prs != '' }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          payload: ${{ steps.slack-msg.outputs.payload }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.STALE_PR_SLACK_NOTIFICATION }}