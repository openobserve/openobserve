name: Claude Auto-Implement

# Trigger on label or @claude_impl comment on issues/PRs
on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]

concurrency:
  group: claude-implement-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  # Prepare job for label/comment triggers - detects if PR or Issue
  prepare-auto:
    if: |
      github.event.sender.type != 'Bot' && (
        (github.event_name == 'issues' && github.event.label.name == 'auto-implement') ||
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude_impl'))
      )
    runs-on: ubuntu-latest
    outputs:
      mode: ${{ steps.detect.outputs.mode }}
      branch: ${{ steps.detect.outputs.branch }}
      pr_number: ${{ steps.detect.outputs.pr_number }}
    steps:
      - name: Detect if PR or Issue
        id: detect
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.E2E_DEV_CI_TOKEN }}
          script: |
            const isPR = !!context.payload.issue.pull_request;
            const num = context.issue.number;

            if (isPR) {
              // Get PR details to get branch name
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: num
              });

              core.setOutput('mode', 'pr_fix');
              core.setOutput('branch', pr.head.ref);
              core.setOutput('pr_number', String(num));
              console.log(`Detected PR #${num} on branch '${pr.head.ref}'`);
            } else {
              core.setOutput('mode', 'implement');
              core.setOutput('branch', '');
              core.setOutput('pr_number', '');
              console.log(`Detected Issue #${num}`);
            }

  # Call o2-enterprise reusable workflow
  auto-implement:
    needs: prepare-auto
    if: |
      github.event.sender.type != 'Bot' && (
        (github.event_name == 'issues' && github.event.label.name == 'auto-implement') ||
        (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude_impl'))
      )

    uses: openobserve/o2-enterprise/.github/workflows/claude-auto-implement-reusable.yml@main
    with:
      source_repo: openobserve
      issue_number: ${{ github.event.issue.number }}
      issue_title: ${{ github.event.issue.title }}
      issue_body: ${{ github.event.issue.body }}
      mode: ${{ needs.prepare-auto.outputs.mode }}
      branch: ${{ needs.prepare-auto.outputs.branch }}
      pr_number: ${{ needs.prepare-auto.outputs.pr_number }}
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      E2E_DEV_CI_TOKEN: ${{ secrets.E2E_DEV_CI_TOKEN }}
