<template>
  <div ref="chartRef" style="height: 100%"></div>
</template>

<script lang="ts">
import { defineComponent, ref, onMounted, onUnmounted } from "vue";
import * as echarts from "echarts";

export default defineComponent({
  name: "SankeyChart",
  setup() {
    const chartRef = ref<HTMLElement | null>(null);
    let chart: any;

    const data = [
      {
            "_timestamp": 1707473417002733,
            "bgp_next_hop": "",
            "bytes": 827,
            "dst_addr": "208.79.13.215",
            "dst_as": 11521,
            "dst_asn_autonomous_system_number": 12105,
            "dst_asn_autonomous_system_organization": "GCN-001",
            "dst_geo_city_name": "Shageluk",
            "dst_geo_continent_code": "NA",
            "dst_geo_country_code": "US",
            "dst_geo_country_name": "United States",
            "dst_geo_latitude": 62.6822,
            "dst_geo_longitude": -159.5619,
            "dst_geo_metro_code": 743,
            "dst_geo_postal_code": "99665",
            "dst_geo_region_code": "AK",
            "dst_geo_region_name": "Alaska",
            "dst_geo_timezone": "America/Anchorage",
            "dst_mac": "00:00:00:00:00:00",
            "dst_net": "192.0.0.0/2",
            "dst_port": 43910,
            "dst_vlan": 0,
            "etype": "IPv4",
            "forwarding_status": 0,
            "fragment_id": 0,
            "fragment_offset": 0,
            "icmp_code": 0,
            "icmp_type": 0,
            "in_if": 0,
            "ip_flags": 0,
            "ip_tos": 0,
            "ip_ttl": 0,
            "ipv6_flow_label": 0,
            "next_hop": "128.163.165.2",
            "next_hop_as": 0,
            "observation_domain_id": 0,
            "observation_point_id": 0,
            "out_if": 0,
            "packets": 224,
            "proto": "TCP",
            "sampler_address": "10.1.62.239",
            "sampling_rate": 0,
            "sequence_num": 3005127,
            "src_addr": "150.119.186.227",
            "src_as": 10229,
            "src_asn_autonomous_system_number": 4152,
            "src_asn_autonomous_system_organization": "USDA-1",
            "src_geo_continent_code": "NA",
            "src_geo_country_code": "US",
            "src_geo_country_name": "United States",
            "src_geo_latitude": 37.751,
            "src_geo_longitude": -97.822,
            "src_geo_timezone": "America/Chicago",
            "src_mac": "00:00:00:00:00:00",
            "src_net": "128.0.0.0/1",
            "src_port": 53318,
            "src_vlan": 0,
            "tcp_flags": 0,
            "time_flow_end_ns": "1707472958911004400",
            "time_flow_start_ns": "1707472569911004400",
            "time_received_ns": 1707473416911177000,
            "type": "NETFLOW_V5",
            "vlan_id": 0
        },
        {
            "_timestamp": 1707473417002667,
            "bgp_next_hop": "",
            "bytes": 315,
            "dst_addr": "77.12.190.94",
            "dst_as": 1688,
            "dst_asn_autonomous_system_number": 6805,
            "dst_asn_autonomous_system_organization": "Telefonica Germany",
            "dst_geo_city_name": "Darmstadt",
            "dst_geo_continent_code": "EU",
            "dst_geo_country_code": "DE",
            "dst_geo_country_name": "Germany",
            "dst_geo_latitude": 49.8604,
            "dst_geo_longitude": 8.6486,
            "dst_geo_postal_code": "64285",
            "dst_geo_region_code": "HE",
            "dst_geo_region_name": "Hesse",
            "dst_geo_timezone": "Europe/Berlin",
            "dst_mac": "00:00:00:00:00:00",
            "dst_net": "77.12.128.0/17",
            "dst_port": 3306,
            "dst_vlan": 0,
            "etype": "IPv4",
            "forwarding_status": 0,
            "fragment_id": 0,
            "fragment_offset": 0,
            "icmp_code": 0,
            "icmp_type": 0,
            "in_if": 0,
            "ip_flags": 0,
            "ip_tos": 0,
            "ip_ttl": 0,
            "ipv6_flow_label": 0,
            "next_hop": "150.20.145.1",
            "next_hop_as": 0,
            "observation_domain_id": 0,
            "observation_point_id": 0,
            "out_if": 0,
            "packets": 454,
            "proto": "TCP",
            "sampler_address": "10.1.62.239",
            "sampling_rate": 0,
            "sequence_num": 3005127,
            "src_addr": "10.154.20.12",
            "src_as": 46667,
            "src_mac": "00:00:00:00:00:00",
            "src_net": "10.154.20.8/29",
            "src_port": 9010,
            "src_vlan": 0,
            "tcp_flags": 0,
            "time_flow_end_ns": "1707472985911004400",
            "time_flow_start_ns": "1707472918911004400",
            "time_received_ns": 1707473416911177000,
            "type": "NETFLOW_V5",
            "vlan_id": 0
        },
        {
            "_timestamp": 1707473417002609,
            "bgp_next_hop": "",
            "bytes": 26,
            "dst_addr": "62.12.190.10",
            "dst_as": 63481,
            "dst_asn_autonomous_system_number": 15623,
            "dst_asn_autonomous_system_organization": "Cyberlink AG",
            "dst_geo_city_name": "Zurich",
            "dst_geo_continent_code": "EU",
            "dst_geo_country_code": "CH",
            "dst_geo_country_name": "Switzerland",
            "dst_geo_latitude": 47.3712,
            "dst_geo_longitude": 8.4789,
            "dst_geo_postal_code": "8047",
            "dst_geo_region_code": "ZH",
            "dst_geo_region_name": "Zurich",
            "dst_geo_timezone": "Europe/Zurich",
            "dst_mac": "00:00:00:00:00:00",
            "dst_net": "48.0.0.0/4",
            "dst_port": 993,
            "dst_vlan": 0,
            "etype": "IPv4",
            "forwarding_status": 0,
            "fragment_id": 0,
            "fragment_offset": 0,
            "icmp_code": 0,
            "icmp_type": 0,
            "in_if": 0,
            "ip_flags": 0,
            "ip_tos": 0,
            "ip_ttl": 0,
            "ipv6_flow_label": 0,
            "next_hop": "131.199.15.1",
            "next_hop_as": 0,
            "observation_domain_id": 0,
            "observation_point_id": 0,
            "out_if": 0,
            "packets": 793,
            "proto": "TCP",
            "sampler_address": "10.1.62.239",
            "sampling_rate": 0,
            "sequence_num": 3005127,
            "src_addr": "172.30.20.102",
            "src_as": 61016,
            "src_mac": "00:00:00:00:00:00",
            "src_net": "172.30.16.0/20",
            "src_port": 9010,
            "src_vlan": 0,
            "tcp_flags": 0,
            "time_flow_end_ns": "1707473393911004400",
            "time_flow_start_ns": "1707472983911004400",
            "time_received_ns": 1707473416911177000,
            "type": "NETFLOW_V5",
            "vlan_id": 0
        },
        {
            "_timestamp": 1707473417002556,
            "bgp_next_hop": "",
            "bytes": 180,
            "dst_addr": "10.12.190.10",
            "dst_as": 65430,
            "dst_mac": "00:00:00:00:00:00",
            "dst_net": "0.0.0.0/1",
            "dst_port": 123,
            "dst_vlan": 0,
            "etype": "IPv4",
            "forwarding_status": 0,
            "fragment_id": 0,
            "fragment_offset": 0,
            "icmp_code": 0,
            "icmp_type": 0,
            "in_if": 0,
            "ip_flags": 0,
            "ip_tos": 0,
            "ip_ttl": 0,
            "ipv6_flow_label": 0,
            "next_hop": "192.199.15.1",
            "next_hop_as": 0,
            "observation_domain_id": 0,
            "observation_point_id": 0,
            "out_if": 0,
            "packets": 661,
            "proto": "UDP",
            "sampler_address": "10.1.62.239",
            "sampling_rate": 0,
            "sequence_num": 3005127,
            "src_addr": "247.104.20.202",
            "src_as": 27502,
            "src_mac": "00:00:00:00:00:00",
            "src_net": "247.104.20.202/32",
            "src_port": 40,
            "src_vlan": 0,
            "tcp_flags": 0,
            "time_flow_end_ns": "1707472979911004400",
            "time_flow_start_ns": "1707472710911004400",
            "time_received_ns": 1707473416911177000,
            "type": "NETFLOW_V5",
            "vlan_id": 0
        },
        {
            "_timestamp": 1707473417002516,
            "bgp_next_hop": "",
            "bytes": 45,
            "dst_addr": "132.12.130.10",
            "dst_as": 47213,
            "dst_asn_autonomous_system_number": 721,
            "dst_asn_autonomous_system_organization": "DNIC-ASBLK-00721-00726",
            "dst_geo_continent_code": "NA",
            "dst_geo_country_code": "US",
            "dst_geo_country_name": "United States",
            "dst_geo_latitude": 37.751,
            "dst_geo_longitude": -97.822,
            "dst_geo_timezone": "America/Chicago",
            "dst_mac": "00:00:00:00:00:00",
            "dst_net": "132.0.0.0/11",
            "dst_port": 0,
            "dst_vlan": 0,
            "etype": "IPv4",
            "forwarding_status": 0,
            "fragment_id": 0,
            "fragment_offset": 0,
            "icmp_code": 0,
            "icmp_type": 0,
            "in_if": 0,
            "ip_flags": 0,
            "ip_tos": 0,
            "ip_ttl": 0,
            "ipv6_flow_label": 0,
            "next_hop": "132.12.130.1",
            "next_hop_as": 0,
            "observation_domain_id": 0,
            "observation_point_id": 0,
            "out_if": 0,
            "packets": 20,
            "proto": "ICMP",
            "sampler_address": "10.1.62.239",
            "sampling_rate": 0,
            "sequence_num": 3005127,
            "src_addr": "172.16.50.10",
            "src_as": 19127,
            "src_mac": "00:00:00:00:00:00",
            "src_net": "172.0.0.0/6",
            "src_port": 0,
            "src_vlan": 0,
            "tcp_flags": 0,
            "time_flow_end_ns": "1707473222911004400",
            "time_flow_start_ns": "1707473197911004400",
            "time_received_ns": 1707473416911177000,
            "type": "NETFLOW_V5",
            "vlan_id": 0
        },
        {
            "_timestamp": 1707473417002465,
            "bgp_next_hop": "",
            "bytes": 519,
            "dst_addr": "10.12.233.210",
            "dst_as": 1453,
            "dst_mac": "00:00:00:00:00:00",
            "dst_net": "0.0.0.0/4",
            "dst_port": 53,
            "dst_vlan": 0,
            "etype": "IPv4",
            "forwarding_status": 0,
            "fragment_id": 0,
            "fragment_offset": 0,
            "icmp_code": 0,
            "icmp_type": 0,
            "in_if": 0,
            "ip_flags": 0,
            "ip_tos": 0,
            "ip_ttl": 0,
            "ipv6_flow_label": 0,
            "next_hop": "39.199.15.1",
            "next_hop_as": 0,
            "observation_domain_id": 0,
            "observation_point_id": 0,
            "out_if": 0,
            "packets": 931,
            "proto": "UDP",
            "sampler_address": "10.1.62.239",
            "sampling_rate": 0,
            "sequence_num": 3005127,
            "src_addr": "59.220.158.122",
            "src_as": 39436,
            "src_geo_continent_code": "AS",
            "src_geo_country_code": "CN",
            "src_geo_country_name": "China",
            "src_geo_latitude": 34.7732,
            "src_geo_longitude": 113.722,
            "src_geo_timezone": "Asia/Shanghai",
            "src_mac": "00:00:00:00:00:00",
            "src_net": "59.192.0.0/11",
            "src_port": 9221,
            "src_vlan": 0,
            "tcp_flags": 0,
            "time_flow_end_ns": "1707473312911004400",
            "time_flow_start_ns": "1707473074911004400",
            "time_received_ns": 1707473416911177000,
            "type": "NETFLOW_V5",
            "vlan_id": 0
        },
        {
            "_timestamp": 1707473417002414,
            "bgp_next_hop": "",
            "bytes": 917,
            "dst_addr": "84.12.190.210",
            "dst_as": 58307,
            "dst_asn_autonomous_system_number": 9105,
            "dst_asn_autonomous_system_organization": "TalkTalk",
            "dst_geo_city_name": "Carshalton",
            "dst_geo_continent_code": "EU",
            "dst_geo_country_code": "GB",
            "dst_geo_country_name": "United Kingdom",
            "dst_geo_latitude": 51.3655,
            "dst_geo_longitude": -0.1632,
            "dst_geo_postal_code": "SM5",
            "dst_geo_region_code": "STN",
            "dst_geo_region_name": "Sutton",
            "dst_geo_timezone": "Europe/London",
            "dst_mac": "00:00:00:00:00:00",
            "dst_net": "84.12.190.208/29",
            "dst_port": 8080,
            "dst_vlan": 0,
            "etype": "IPv4",
            "forwarding_status": 0,
            "fragment_id": 0,
            "fragment_offset": 0,
            "icmp_code": 0,
            "icmp_type": 0,
            "in_if": 0,
            "ip_flags": 0,
            "ip_tos": 0,
            "ip_ttl": 0,
            "ipv6_flow_label": 0,
            "next_hop": "192.199.15.1",
            "next_hop_as": 0,
            "observation_domain_id": 0,
            "observation_point_id": 0,
            "out_if": 0,
            "packets": 537,
            "proto": "TCP",
            "sampler_address": "10.1.62.239",
            "sampling_rate": 0,
            "sequence_num": 3005127,
            "src_addr": "10.10.20.122",
            "src_as": 13185,
            "src_mac": "00:00:00:00:00:00",
            "src_net": "0.0.0.0/2",
            "src_port": 12001,
            "src_vlan": 0,
            "tcp_flags": 0,
            "time_flow_end_ns": "1707473087911004400",
            "time_flow_start_ns": "1707472951911004400",
            "time_received_ns": 1707473416911177000,
            "type": "NETFLOW_V5",
            "vlan_id": 0
        },
        {
            "_timestamp": 1707473417002344,
            "bgp_next_hop": "",
            "bytes": 2,
            "dst_addr": "202.12.190.10",
            "dst_as": 51415,
            "dst_asn_autonomous_system_number": 1221,
            "dst_asn_autonomous_system_organization": "Telstra Corporation Ltd",
            "dst_geo_continent_code": "OC",
            "dst_geo_country_code": "AU",
            "dst_geo_country_name": "Australia",
            "dst_geo_latitude": -33.494,
            "dst_geo_longitude": 143.2104,
            "dst_geo_timezone": "Australia/Sydney",
            "dst_mac": "00:00:00:00:00:00",
            "dst_net": "202.12.190.8/30",
            "dst_port": 443,
            "dst_vlan": 0,
            "etype": "IPv4",
            "forwarding_status": 0,
            "fragment_id": 0,
            "fragment_offset": 0,
            "icmp_code": 0,
            "icmp_type": 0,
            "in_if": 0,
            "ip_flags": 0,
            "ip_tos": 0,
            "ip_ttl": 0,
            "ipv6_flow_label": 0,
            "next_hop": "172.199.15.1",
            "next_hop_as": 0,
            "observation_domain_id": 0,
            "observation_point_id": 0,
            "out_if": 0,
            "packets": 572,
            "proto": "TCP",
            "sampler_address": "10.1.62.239",
            "sampling_rate": 0,
            "sequence_num": 3005127,
            "src_addr": "192.168.20.10",
            "src_as": 43975,
            "src_mac": "00:00:00:00:00:00",
            "src_net": "192.168.0.0/18",
            "src_port": 40,
            "src_vlan": 0,
            "tcp_flags": 0,
            "time_flow_end_ns": "1707473285911004400",
            "time_flow_start_ns": "1707473162911004400",
            "time_received_ns": 1707473416911177000,
            "type": "NETFLOW_V5",
            "vlan_id": 0
        },
        {
            "_timestamp": 1707473417002294,
            "bgp_next_hop": "",
            "bytes": 900,
            "dst_addr": "172.30.190.10",
            "dst_as": 12271,
            "dst_mac": "00:00:00:00:00:00",
            "dst_net": "172.30.190.0/25",
            "dst_port": 80,
            "dst_vlan": 0,
            "etype": "IPv4",
            "forwarding_status": 0,
            "fragment_id": 0,
            "fragment_offset": 0,
            "icmp_code": 0,
            "icmp_type": 0,
            "in_if": 0,
            "ip_flags": 0,
            "ip_tos": 0,
            "ip_ttl": 0,
            "ipv6_flow_label": 0,
            "next_hop": "172.199.15.1",
            "next_hop_as": 0,
            "observation_domain_id": 0,
            "observation_point_id": 0,
            "out_if": 0,
            "packets": 864,
            "proto": "TCP",
            "sampler_address": "10.1.62.239",
            "sampling_rate": 0,
            "sequence_num": 3005127,
            "src_addr": "112.10.20.10",
            "src_as": 39409,
            "src_asn_autonomous_system_number": 56041,
            "src_asn_autonomous_system_organization": "China Mobile communications corporation",
            "src_geo_continent_code": "AS",
            "src_geo_country_code": "CN",
            "src_geo_country_name": "China",
            "src_geo_latitude": 34.7732,
            "src_geo_longitude": 113.722,
            "src_geo_timezone": "Asia/Shanghai",
            "src_mac": "00:00:00:00:00:00",
            "src_net": "112.0.0.0/12",
            "src_port": 40,
            "src_vlan": 0,
            "tcp_flags": 0,
            "time_flow_end_ns": "1707473059911004400",
            "time_flow_start_ns": "1707472629911004400",
            "time_received_ns": 1707473416911177000,
            "type": "NETFLOW_V5",
            "vlan_id": 0
        },
        {
            "_timestamp": 1707473417002243,
            "bgp_next_hop": "",
            "bytes": 655,
            "dst_addr": "226.4.119.88",
            "dst_as": 56488,
            "dst_mac": "00:00:00:00:00:00",
            "dst_net": "224.0.0.0/6",
            "dst_port": 59191,
            "dst_vlan": 0,
            "etype": "IPv4",
            "forwarding_status": 0,
            "fragment_id": 0,
            "fragment_offset": 0,
            "icmp_code": 0,
            "icmp_type": 0,
            "in_if": 0,
            "ip_flags": 0,
            "ip_tos": 0,
            "ip_ttl": 0,
            "ipv6_flow_label": 0,
            "next_hop": "90.14.241.149",
            "next_hop_as": 0,
            "observation_domain_id": 0,
            "observation_point_id": 0,
            "out_if": 0,
            "packets": 657,
            "proto": "TCP",
            "sampler_address": "10.1.62.239",
            "sampling_rate": 0,
            "sequence_num": 3005126,
            "src_addr": "150.78.36.50",
            "src_as": 41225,
            "src_geo_continent_code": "AS",
            "src_geo_country_code": "JP",
            "src_geo_country_name": "Japan",
            "src_geo_latitude": 35.6897,
            "src_geo_longitude": 139.6895,
            "src_geo_timezone": "Asia/Tokyo",
            "src_mac": "00:00:00:00:00:00",
            "src_net": "150.78.32.0/21",
            "src_port": 25905,
            "src_vlan": 0,
            "tcp_flags": 0,
            "time_flow_end_ns": "1707473215553403400",
            "time_flow_start_ns": "1707472756553403400",
            "time_received_ns": 1707473416553567700,
            "type": "NETFLOW_V5",
            "vlan_id": 0
        },
        {
            "_timestamp": 1707473417002193,
            "bgp_next_hop": "",
            "bytes": 24,
            "dst_addr": "132.12.130.10",
            "dst_as": 64416,
            "dst_asn_autonomous_system_number": 721,
            "dst_asn_autonomous_system_organization": "DNIC-ASBLK-00721-00726",
            "dst_geo_continent_code": "NA",
            "dst_geo_country_code": "US",
            "dst_geo_country_name": "United States",
            "dst_geo_latitude": 37.751,
            "dst_geo_longitude": -97.822,
            "dst_geo_timezone": "America/Chicago",
            "dst_mac": "00:00:00:00:00:00",
            "dst_net": "132.12.130.10/31",
            "dst_port": 0,
            "dst_vlan": 0,
            "etype": "IPv4",
            "forwarding_status": 0,
            "fragment_id": 0,
            "fragment_offset": 0,
            "icmp_code": 0,
            "icmp_type": 0,
            "in_if": 0,
            "ip_flags": 0,
            "ip_tos": 0,
            "ip_ttl": 0,
            "ipv6_flow_label": 0,
            "next_hop": "132.12.130.1",
            "next_hop_as": 0,
            "observation_domain_id": 0,
            "observation_point_id": 0,
            "out_if": 0,
            "packets": 178,
            "proto": "ICMP",
            "sampler_address": "10.1.62.239",
            "sampling_rate": 0,
            "sequence_num": 3005126,
            "src_addr": "172.16.50.10",
            "src_as": 42585,
            "src_mac": "00:00:00:00:00:00",
            "src_net": "172.16.0.0/12",
            "src_port": 0,
            "src_vlan": 0,
            "tcp_flags": 0,
            "time_flow_end_ns": "1707473041553403400",
            "time_flow_start_ns": "1707472907553403400",
            "time_received_ns": 1707473416553567700,
            "type": "NETFLOW_V5",
            "vlan_id": 0
        },
    ];

    const initializeChart = () => {
      chart = echarts.init(chartRef.value);
      chart.setOption(getChartOptions());
    };

    const getChartOptions = () => {
      const nodesMap: Map<string, number> = new Map(); // Map to store node names and their indices
      const nodes: any[] = [];
      const links: any[] = [];

      data.forEach((item) => {
        // Check if source node exists, if not, add it to nodes array
        if (!nodesMap.has(item.src_geo_country_name)) {
          nodesMap.set(item.src_geo_country_name, nodes.length);
          nodes.push({ name: item.src_geo_country_name });
        }
        // Check if target node exists, if not, add it to nodes array
        if (!nodesMap.has(item.dst_geo_country_name)) {
          nodesMap.set(item.dst_geo_country_name, nodes.length);
          nodes.push({ name: item.dst_geo_country_name });
        }
        // Add link
        const sourceIndex = nodesMap.get(item.src_geo_country_name);
        const targetIndex = nodesMap.get(item.dst_geo_country_name);

        // Check for circular dependency
        if (sourceIndex === targetIndex) {
          //   console.error('Circular dependency detected:', item);
          return; // Skip adding this link
        }

        links.push({
          source: sourceIndex,
          target: targetIndex,
          value: item.bytes,
          lineStyle: {
            curveness: 0.5, // Adjust this value to control the curvature of the lines
          },
        });
      });

      const options = {
        tooltip: {},
        series: {
          type: "sankey",
          layout: "none",
          data: nodes,
          links: links,
          emphasis: {
            focus: "adjacency",
          },
        },
      };

      return options;
    };

    onMounted(() => {
      initializeChart();
    });

    onUnmounted(() => {
      chart.dispose();
    });

    return { chartRef };
  },
});
</script>
